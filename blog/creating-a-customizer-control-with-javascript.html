<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        <!-- Page Info -->
        <title>
            Creating a Customizer control with JavaScript &ndash; &lbrace;
            LebCit &rbrace;
        </title>
        <meta name="theme-color" content="#3d4f5d" />
        <meta
            name="description"
            content="This post is about creating a control, from A to Z, in WordPress Customizer with JavaScript."
        />

        <!-- Favicon -->
        <link
            rel="icon"
            type="image/png"
            sizes="16x16"
            href="/img/favicon//favicon-16x16.png"
        />
        <link
            rel="icon"
            type="image/png"
            sizes="32x32"
            href="/img/favicon/favicon-32x32.png"
        />
        <link
            rel="apple-touch-icon"
            sizes="180x180"
            href="/img/favicon/apple-touch-icon.png"
        />
        <link
            rel="icon"
            type="image/png"
            sizes="192x192"
            href="/img/favicon/android-chrome-192x192.png"
        />
        <link
            rel="icon"
            type="image/png"
            sizes="512x512"
            href="/img/favicon/android-chrome-512x512.png"
        />

        <!-- Styles -->
        <link rel="stylesheet" href="/vendor/normalize-min.css" />
        <link rel="stylesheet" href="/style.css" />
    </head>

    <body class="js-customizer-control">
        <div id="layout" class="grid">
            <a class="skip-link screen-reader-text" href="#content"
                >Skip to content</a
            >

            <main-navigation></main-navigation>

            <the-header></the-header>

            <div id="content" class="content unit-1 unit-lg-3-5" rel="main">
                <!-- A wrapper for every single post -->
                <div class="single-post">
                    <!-- A single post -->
                    <section class="post-single">
                        <header class="post-header">
                            <h2 class="post-title">
                                Creating a Customizer control with JavaScript
                            </h2>

                            <p class="post-meta">
                                Posted on
                                <span class="posted-on">01 June 2020</span>
                                under
                                <span class="post-category">Development</span>
                                <span class="post-category">Customizer</span>
                            </p>
                        </header>

                        <div class="post-content">
                            <p>
                                <em
                                    >This post is about creating a control, from
                                    A to Z, in WordPress Customizer with
                                    JavaScript.</em
                                >
                            </p>

                            <p>
                                Did you know that you can create panels,
                                sections and controls in the Customizer with
                                JavaScript ?<br />"The PHP API for their
                                registration is essentially a wrapper for the
                                underlying JS API" as mentioned by Weston Ruter
                                in
                                <a
                                    href="https://wp.me/p2AvED-6c4"
                                    target="_blank"
                                    rel="external noopener noreferrer"
                                    >Improvements to the Customize JS API in 4.9
                                    <i
                                        class="gg-external"
                                        role="img"
                                        aria-label=" (opens in a new tab)"
                                    ></i
                                ></a>
                            </p>
                            <p>
                                He also says "you can also avoid statically
                                registering settings and partials in PHP by
                                instead adding filters to dynamically recognize
                                settings and partials, allowing them to be
                                registered on demand", meaning that you can
                                create settings and partials in JS but will have
                                to register them in PHP via a filter because
                                they must be sanitized and validated by the
                                server for security reasons !
                            </p>
                            <p>
                                For this task, we need to :<br />
                                - access the Customizer Pane to create a Panel,
                                a Section, a Setting and a Control with JS<br />
                                - access the Customizer Preview to define the
                                related Partial of the Control with JS<br />
                                - add a filter to validate and sanitize the
                                Setting with PHP<br />
                                For more information about how things are
                                related in the Customizer, please read my post
                                "<a
                                    href="https://lebcit.github.io/blog/listen-for-changes-in-customizer-preview.html"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    ><em
                                        >Listen for changes in Customizer
                                        Preview !
                                        <i
                                            class="gg-external"
                                            role="img"
                                            aria-label=" (opens in a new tab)"
                                        ></i></em
                                ></a>
                                "
                            </p>
                            <p>
                                I'll explain it as if the reader is a beginner
                                so she/he can understand and follow along.
                            </p>
                            My tree looks like this:
                            <pre>
- theme ( main folder)
-- inc (folder)
--- customizer.php
-- js (folder)
--- controls.js
--- customizer.js
--- main.js
-- functions.php</pre
                            >
                            <p>
                                The functions.php file is used to :<br />-
                                enqueue and localize main.js where we will
                                render on the front end our choice(s) from the
                                Customizer<br />- require the customizer.php
                                file where we hook control.js (for Customizer
                                Pane) and customizer.js (for Customizer
                                Preview)<br />We can of course hook control.js
                                and customizer.js from functions.php but it's
                                better to keep things separated.
                            </p>
                            <pre>// File functions.php<code>
/**
 * Load and localize main.js.
 */
function main_js() {
    wp_enqueue_script( 'main-js', get_theme_file_uri( '/js/main.js' ), array(), '1.0', true );
    // Localize the script with new data and pass php variables to JS.
    $main_js_data = array(
        /** FOR LATER USE. */
        'siteTitleColor' =&gt; get_theme_mod('siteTitleColorSetting', '#fff'),
    );
    wp_localize_script( 'main-js', 'main_vars', $main_js_data );
}
add_action( 'wp_enqueue_scripts', 'main_js' );

/**
 * Customizer additions.
 */
require get_template_directory() . '/inc/customizer.php';</code></pre>
                            <pre>// File customizer.php<code>
/**
 * Hooking in JS code to affect the controls in the Customizer.
 */
function midday_customize_controls_js() {
    wp_enqueue_script( 'midday-controls', get_template_directory_uri() . '/js/controls.js', array( 'customize-controls' ), filemtime( get_theme_file_path( '/js/controls.js' ) ), true );
}
add_action( 'customize_controls_enqueue_scripts', 'midday_customize_controls_js' );

/**
 * Binds JS handlers to make Theme Customizer preview reload changes asynchronously.
 */
function midday_customize_preview_js() {
    wp_enqueue_script( 'midday-customizer', get_template_directory_uri() . '/js/customizer.js', array( 'customize-preview' ), '20151215', true );
}
add_action( 'customize_preview_init', 'midday_customize_preview_js' );</code></pre>
                            <p>
                                If you don't know what is
                                <a
                                    href="https://developer.wordpress.org/reference/functions/wp_localize_script/"
                                    target="_blank"
                                    rel="external noopener noreferrer"
                                    >wp_localize_script()
                                    <i
                                        class="gg-external"
                                        role="img"
                                        aria-label=" (opens in a new tab)"
                                    ></i
                                ></a>
                                , think of it as a bridge between PHP and JS
                                where we can pass variables from PHP to JS.<br />Just
                                to let you know, there is also another
                                function<a
                                    href="https://developer.wordpress.org/reference/functions/wp_add_inline_script/"
                                    target="_blank"
                                    rel="external noopener noreferrer"
                                >
                                    wp_add_inline_script()
                                    <i
                                        class="gg-external"
                                        role="img"
                                        aria-label=" (opens in a new tab)"
                                    ></i
                                ></a>
                                to add JS code to a registered JS file.
                            </p>
                            <p>
                                Now that we are all set, let's create a Panel, a
                                Section, a Setting and a Control in control.js
                                to change the site title color.
                            </p>
                            <pre>/**
 * File controls.js
 *
 * Access Theme Customizer Controls for a better user experience.
 */<code>
(function (api) {
    api.bind('ready', function () {
        // Create panel.
    api.panel.add(
        new api.Panel('myPanel', {
        title: 'Theme Options',
                description: 'Customize Theme',
                priority: 5 // Optional default is 160.
        })
    );
        // Site Title Color Section.
        api.section.add(
            new api.Section('siteTitleColorSection', {
                title: 'Site Title Color Section',
                panel: 'myPanel',
                customizeAction: 'Customizing ▸ Site Title Color', // String above title's Section.
                priority: 5 // The order of this section in the panel.
            })
        );
        // Site Title Color Setting.
        api.add(
            new api.Setting('siteTitleColorSetting', '#fff', {
                transport: 'postMessage'
            })
        );
        // Site Title Color Control.
        api.control.add(
        new wp.customize.ColorControl('siteTitleColorControl', {
                section: 'siteTitleColorSection',
                label : 'Site Title Color Control',
        setting: 'siteTitleColorSetting',
                priority: 5 // The order of this control in the section.
        })
    );
    });
}) (wp.customize);</code></pre>
                            <p>
                                Please note that the pattern for the Setting is
                                different from the others !<br />For the
                                Setting, we type
                                <code>api.add(setting)</code> and define in the
                                <code>setting</code> an <code>id</code>, a
                                <code>defaultValue</code>, then we pass the
                                desired call type (here we are using
                                <code>postMessage</code>).
                            </p>
                            <p>
                                Now, let's access the Customizer Preview in
                                customizer.js and define how the Setting joins
                                the Control to the Partial.
                            </p>
                            <pre>/**
 * File customizer.js.
 *
 * Theme Customizer enhancements for a better user experience.
 *
 * Contains handlers to make Theme Customizer preview reload changes asynchronously.
 */

<code>(function ($) {
    // Site Title Color.
    wp.customize("siteTitleColorSetting", function (value) {
        value.bind(function (new_value) {
            $(".site-title a").css("color", new_value);
        });
    });
}(jQuery));</code></pre>
                            <p>
                                Now, let's add in customizer.php the filter to
                                validate and sanitize our Setting, preferably
                                (for logic) after the code that hooks
                                controls.js
                            </p>
                            <pre>// File customizer.php<code>
add_filter(
    'customize_dynamic_setting_args',
    function( $setting_args, $setting_id ) {
        if ( 'siteTitleColorSetting' === $setting_id ) {
            $setting_args = array(
                'sanitize_callback' =&gt; 'sanitize_hex_color',
            );
        }
        return $setting_args;
    },
    10,
    2
);</code></pre>
                            <p>
                                As you can see, the above function uses the
                                <code
                                    ><a
                                        href="https://developer.wordpress.org/reference/hooks/customize_dynamic_setting_args/"
                                        target="_blank"
                                        rel="external noopener noreferrer"
                                        >customize_dynamic_setting_args
                                        <i
                                            class="gg-external"
                                            role="img"
                                            aria-label=" (opens in a new tab)"
                                        ></i></a
                                ></code>
                                filter to tell the server to validate/recognize
                                the Setting and to sanitize it.<br />The number
                                10 is the priority of execution of the function,
                                and the number 2 is the number of arguments the
                                function accepts.<br />More info about
                                <a
                                    href="https://developer.wordpress.org/reference/functions/add_filter/"
                                    target="_blank"
                                    rel="external noopener noreferrer"
                                    >add_filter()
                                    <i
                                        class="gg-external"
                                        role="img"
                                        aria-label=" (opens in a new tab)"
                                    ></i
                                ></a>
                                in the Code Reference.
                            </p>
                            <p>
                                Now, if you go to the Customizer, you'll find
                                the created panel, section, setting and
                                control.<br />
                                If you try to change the site title it will
                                change according to your choice.<br />But if you
                                publish it, nothing will happen on the front end
                                🤔<br />So, our final step is to render/reflect
                                our choice in the Customizer on the front
                                end.<br />
                                Remember the beginning of this post ?<br />We
                                have loaded and localized main.js for this
                                purpose 😉<br />
                                Open main.js and add the following code
                            </p>
                            <pre>/**
 * File main.js.
 *
 * Handles theme's JS functions.
 */
<code>"use strict";

const siteTitleColor = midday_vars.siteTitleColor; // Retriving the passed variable from PHP to JS.
const siteTitleAnchor = document.querySelector('.site-title a'); // Select the site title anchor.
if (siteTitleColor) { // If their is any value.
    siteTitleAnchor.style.color = siteTitleColor; // Add this value as a color to the site title anchor.
}</code></pre>
                            <p>
                                The code is explained and easy to understand, if
                                you have any question don't hesitate !
                            </p>
                            <p>
                                As a final note, I would like to let you know
                                that I've created the same control with PHP
                                along with the JS one.<br />When we change the
                                site title color with the PHP control (let's say
                                <code>#000</code>) and the JS control (let's say
                                <code>#fff</code>) and publish our changes, it's
                                the JS control that takes over 💪
                            </p>
                            <p>
                                Hope this post will help you begin using the
                                Customizer's JS API instead of it's PHP API 😊
                            </p>
                            <p>SYA,<br />LebCit.</p>
                        </div>
                    </section>
                </div>

                <div class="footer unit-1"></div>
            </div>
        </div>

        <script src="/global.js"></script>
    </body>
</html>
